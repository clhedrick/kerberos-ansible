from ipaserver.plugins import user
from ipaserver.plugins import group
from ipalib.parameters import Str
from ipalib import _

user.user.takes_params = user.user.takes_params + (
 Str('samaccountname?',
 cli_name='windowsname',
 label=_('Windows account name'),
 ),
)
user.user.default_attributes.append('samaccountname')

group.group.takes_params = group.group.takes_params + (
 Str('businesscategory*',
 cli_name='categories',
 label=_('Categories (specify "login" for login group)'),
 ),
)
group.group.default_attributes.append('businesscategory')

group.group.takes_params = group.group.takes_params + (
 Str('host*',
 cli_name='hosts',
 label=_('Hosts (use as cluster names for login group)'),
 ),
)
group.group.default_attributes.append('host')

def useradd_precallback(self, ldap, dn, entry, attrs_list,
*keys, **options):
    if 'samaccountname' not in entry.keys():
        entry['samaccountname'] = entry['uid']
    if 'mail' not in entry.keys():
        entry['mail'] = entry['uid'] + '@rutgers.edu'
    if 'gidnumber' not in entry.keys():
        entry['gidnumber'] = '1234'
    return dn

user.user_add.register_pre_callback(useradd_precallback, first=True)

# For some reason this ignores the text in cli_name and label

group.group.takes_params = group.group.takes_params + (
 Str('owner*',
 cli_name='owners',
 label=_('Owners'),
 normalizer=lambda value: value if ',' in value else 'uid=' + value + ',cn=users,cn=accounts,dc=cs,dc=rutgers,dc=edu',
 ),
)

group.group.default_attributes.append('owner')

user.user.takes_params = user.user.takes_params + (
 Str('dellemcgroup?',
 cli_name='dellgroup',
 label=_('Dell Group'),
 doc=_('Dell Group: sysadmin, secadmin, netadmin, or netoperator'),
 ),
)

user.user.default_attributes.append('dellemcgroup')
